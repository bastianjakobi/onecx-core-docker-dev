# OneCX Portal - Local dev setup

## Before

### Scripts
Make sure that .sh scripts in / directory are executable

- e.g. `-rwxr-xr-x start.sh`
- if they are not executable, use the command `chmod +x <file>`

### Hosts file

In order to expose multiple services on the same port, we use a traefik reverse proxy. It will be available via your hosts 80 port, and will route traffic to containers based on hostnames.

Therefore, for each service you want to access, add an entry to your hosts files: Windows: `c:\Windows\System32\drivers\etc\hosts` and Linux / WSL: `/etc/hosts`(wsl hosts file will be autogenerated from windows file when you restart wsl, unless you disabled that behaviour). 

A sample hosts file containing all necessary entries can be found in this repo (hosts.sample).

## Docker compose

The docker compose in this repo currently contains the following apps and services:

Core infra:

- `traefik` reverse proxy
- `postgresdb` generic postgresql db
- `keycloak-app` Access and Identity Management Tool (credentials are: admin/admin)

Core apps:

- `tkit-portal-server` Main MS for tkit portal applications, managing and storing informations about Portals and Users
- `apm` MS which manages access and permissions for Portal users
- `tkit-menu-management-bff` BFF used by UI apps for sending requests to tkit-portal-server
- `portal-mf-shell` Main UI application that provides module federation shell app
- `portal-mgmt` UI application for managing portals, microfrontends, themes and menus

## Usage

To start the applications just run `./start.sh` locally. This script will spin up all necessary containers using docker-compose and will import all needed apm permissions using `setupPermissions.sh`. After the script has been executed successfully you should be able to access the portal on http://ui/portal-mf-shell/admin and log in with the default Keycloak user mentioned below.

## Initial Data

A Postgres server with all necessary databases is automatically created on startup. 

The database for Keycloak is populated with the following configuration:

- **Realm** - OneCx
- **Clients** - ping-angular-app-ui
- **User** - onecx
- **Password** - onecx
- **Roles assigned to the user** - [onecx-portal-admin, onecx-portal-user, onecx-admin, tkit-portal-admin]

Additionally, some sample data is imported into the database used by tkit-portal-server (see ./tkit-portal-server-init for details).

## App configurations

To configure your local applications to work together with the services provided by this repo, change the corresponding addresses of the services in your local app configuration, using only hostnames of the docker services.

**proxy-conf.json** example:

```json
  "/portal-api": {
    "target": "http://tkit-portal-server",
    "secure": false,
    "pathRewrite": {
      "^/portal-api": ""
    },
    "changeOrigin": true,
    "logLevel": "debug"
  },

```

**env.json** example:

```json
  "KEYCLOAK_REALM": "OneCX",
  "KEYCLOAK_URL": "http://keycloak-app/",
  "KEYCLOAK_CLIENT_ID": "ping-angular-app-ui",
  "TKIT_PORTAL_ID": "ADMIN",
```
