# OneCX apps - local dev setup

## Before

Make sure that .sh scripts in /scripts directory are executable

- e.g. `-rwxr-xr-x wait-for.sh`
- if they are not executable, use the command `chmod +x <file>`

## Docker compose

The docker compose in this repo currently contains:

- `postgresdb` generic postgresql db
- `traefik` reverse proxy
- `keycloak-app` Access and Identity Management Tool (credentials are: admin/admin)
- `tkit-portal-server` Main MS for tkit portal applications, managing and storing informations about Portals and Users
- `apm` MS which manages access and permissions for Portal users

To run the services execute:

- `docker-compose up -d`

## Hosts file

In order to expose multiple services on the same port, we use traefik reverse proxy. It will be available via your hosts 80 port, and will route traffik to containers based on hostnames.
Therefore, for each service you want to access, do add an entry to your hosts files Windows: `c:\Windows\System32\drivers\etc\hosts` and Linux / WSL: `/etc/hosts`(wsl hosts file will be autogenerated from windows file when you restart wsl, unless you disabled that behaviour). Sample file (hosts.sample) is in this repo.

## Initial Data

Postgres server is automatically created with the necessary databases.

Keycloak db is populated with the following configuration:

- **Realm** - OneCx
- **Clients** - ping-angular-app, portal-mf-shell
- **User** - onecx
- **Password** - onecx
- **Roles assigned to the user** - [onecx-portal-admin, onecx-portal-user, onecx-admin, tkit-portal-admin]

Automatic import of basic portal data into tkit-portal-server is enabled.

## App configurations

To configure your local applications to work together with services from this compose, change the corresponding addresses of the dependent services in your local app, using only hostnames of the docker services.

**proxy-conf.json** example:

```json
  "/portal-api": {
    "target": "http://tkit-portal-server",
    "secure": false,
    "pathRewrite": {
      "^/portal-api": ""
    },
    "changeOrigin": true,
    "logLevel": "debug"
  },

```

**env.json** example:

```json
  "KEYCLOAK_REALM": "OneCX",
  "KEYCLOAK_URL": "http://keycloak-app/",
  "KEYCLOAK_CLIENT_ID": "ping-angular-app-ui",
  "TKIT_PORTAL_ID": "ADMIN",
```
